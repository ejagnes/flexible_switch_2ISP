!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
!!!!!!!!                                                                            !!!!!!!!
!!!!!!!!        MAIN SIMULATION -> CALLS ROUTINES FOR INPUT, NEURON AND DATA OUTPUT !!!!!!!!
!!!!!!!!                                                                            !!!!!!!!
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!


!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
!!!!!!!!            SIMULATION WITHOUT PLASTICITY FOR CORRELATION MEASURE           !!!!!!!!
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
	SUBROUTINE simulation(tot_time_r)	!tot_time_r = time in minutes
	USE VARIABLES
	USE PARAMETERS
	IMPLICIT NONE
	INTEGER 		::	t,tt,tot_time
	REAL*8			::	tot_time_r
	tot_time = INT(tot_time_r*60.0d0)	!total simulation time
!================================ main loop ===============================================!
	DO tt = 1,tot_time
	!---------------------------loop over one second of neuronal time--------------------------!
		DO t = 1,one_sec
			tr = tr + dt		!from interation to neuronal time
			CALL input_g(t)		!inhomogeneous input onto postsynaptic neuron
			CALL lif()		!leaky integrate-and-fire neuron
			CALL averages()		!calculate averate for input and ouput rate
		END DO
		CALL averages2()		!calculate averate for input and ouput rate
	!------------------------------------------------------------------------------------------!
	END DO
	CALL outputs(tot_time)			!file output for correlation
!==========================================================================================!
	END SUBROUTINE
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!


!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
!!!!!!!!        CALCULATION OF AVERAGES IN ONE SECOND FOR INPUT AND OUTPUT          !!!!!!!!
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
	SUBROUTINE averages()
	USE VARIABLES
	IMPLICIT NONE
!-------------------------------- average output rate -------------------------------------!
	x(6) = x(6) + x(5)
!------------------------------------------------------------------------------------------!
!---------------------------- square of average output rate -------------------------------!
	x(7) = x(7) + x(5)*x(5)
!------------------------------------------------------------------------------------------!
!-------------------------------- average input rate --------------------------------------!
	activity_av = activity_av + (activity/200.0d0)
!------------------------------------------------------------------------------------------!
!---------------------------- square of average input rate --------------------------------!
	activity_av2 = activity_av2 + (activity/200.0d0)*(activity/200.0d0)
!------------------------------------------------------------------------------------------!
!------------------------- average of cross term (input*output) ---------------------------!
	cross_activity = cross_activity + (activity/200.0d0)*x(5)
!------------------------------------------------------------------------------------------!
	END SUBROUTINE
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!

!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
!!!!!!!!        CALCULATION OF AVERAGES IN ONE MINUTE FOR INPUT AND OUTPUT          !!!!!!!!
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
	SUBROUTINE averages2()
	USE VARIABLES
	USE PARAMETERS
	IMPLICIT NONE
!-------------------------------- average output rate -------------------------------------!
	x(8) = x(8) + x(6)/DBLE(one_sec)
!------------------------------------------------------------------------------------------!
!---------------------------- square of average output rate -------------------------------!
	x(9) = x(9) + x(7)/DBLE(one_sec)
!------------------------------------------------------------------------------------------!
!-------------------------------- average input rate --------------------------------------!
	activity_av_t = activity_av_t + activity_av/DBLE(one_sec)
!------------------------------------------------------------------------------------------!
!---------------------------- square of average input rate --------------------------------!
	activity_av_t2 = activity_av_t2 + activity_av2/DBLE(one_sec)
!------------------------------------------------------------------------------------------!
!------------------------- average of cross term (input*output) ---------------------------!
	cross_activity_t = cross_activity_t + cross_activity/DBLE(one_sec)
!------------------------------------------------------------------------------------------!
!---------------------------------- reset variables ---------------------------------------!
	x(6:7) = 0.0d0
	activity_av = 0.0d0
	activity_av2 = 0.0d0
	cross_activity = 0.0d0
!------------------------------------------------------------------------------------------!
	END SUBROUTINE
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!


!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
!!!!!!!!                        DATA OUTPUT FOR PLOT                                !!!!!!!!
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
	SUBROUTINE outputs(tot_time)
	USE VARIABLES
	USE PARAMETERS
	IMPLICIT NONE
	INTEGER			::	tot_time,pw
	REAL*8,ALLOCATABLE	::	covariance(:),norm(:)
!--------------------- arrays to calculate covariance and normalization (SD) --------------!
	ALLOCATE(covariance(n_pw),norm(n_pw))
!------------------------------------------------------------------------------------------!
!-------------------------------- average output rate -------------------------------------!
	x(8) = x(8)/DBLE(tot_time)
!------------------------------------------------------------------------------------------!
!---------------------------- square of average output rate -------------------------------!
	x(9) = x(9)/DBLE(tot_time)
!------------------------------------------------------------------------------------------!
!-------------------------------- average input rate --------------------------------------!
	activity_av_t = activity_av_t/DBLE(tot_time)
!------------------------------------------------------------------------------------------!
!---------------------------- square of average input rate --------------------------------!
	activity_av_t2 = activity_av_t2/DBLE(tot_time)
!------------------------------------------------------------------------------------------!
!------------------------- average of cross term (input*output) ---------------------------!
	cross_activity_t = cross_activity_t/DBLE(tot_time)
!------------------------------------------------------------------------------------------!
!------------------------------ covariance (input and output) -----------------------------!
	covariance = cross_activity_t - x(8)*activity_av_t
!------------------------------------------------------------------------------------------!
!----------------------- norm term for Pearson correlation SD*SD --------------------------!
	norm = DSQRT( (activity_av_t2 - (activity_av_t**2))*(x(9) - (x(8)**2)) )
!------------------------------------------------------------------------------------------!
!--------------------------------- output to file -----------------------------------------!
	DO pw = 1,n_pw
		WRITE(1,*)pw,covariance(pw)/norm(pw)
	END DO
!------------------------------------------------------------------------------------------!
!----------------------------- deallocate arrays for next sim -----------------------------!
	DEALLOCATE(covariance,norm)
!------------------------------------------------------------------------------------------!
	END SUBROUTINE
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
