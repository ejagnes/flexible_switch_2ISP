!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
!!!!!!!!                                                                            !!!!!!!!
!!!!!!!!        MAIN SIMULATION -> CALLS ROUTINES FOR INPUT, NEURON AND DATA OUTPUT !!!!!!!!
!!!!!!!!                                                                            !!!!!!!!
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
	SUBROUTINE simulation0(tot_time_r)		!tot_time_r = time in seconds
	USE VARIABLES
	USE PARAMETERS
	IMPLICIT NONE
	INTEGER 		::	t,tt,tot_time
	REAL*8			::	tot_time_r

!========================== TOTAL SIMULATION TIME =========================================!
	tot_time = INT(tot_time_r)
!==========================================================================================!
!================================ MAIN LOOP ===============================================!
	DO tt = 1,tot_time
	!---------------------------loop over one second of neuronal time--------------------------!
		DO t = 1,one_sec
		!---------------------------from iteration to neuronal time--------------------------------!
			tr = tr + dt
		!-------------------------inhomogeneous input onto postsynaptic neuron---------------------!
			CALL input_g(t)
		!----------------------------leaky integrate-and-fire neuron-------------------------------!
			CALL lif()
		!--------------------------------output data for plots-------------------------------------!
			CALL output()
		END DO
	!------------------------------------------------------------------------------------------!
	END DO
!==========================================================================================!
	END SUBROUTINE
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!


!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
!!!!!!!!                                                                            !!!!!!!!
!!!!!!!!                        DATA OUTPUT FOR PLOTS                               !!!!!!!!
!!!!!!!!                                                                            !!!!!!!!
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
	SUBROUTINE output()
	USE VARIABLES
	USE PARAMETERS
	IMPLICIT NONE
	INTEGER		::	pw,j0,jf

!========================== CURRENTS PER PATTERN ==========================================!
	DO pw = 1,n_pw
	!--------------------------excitatory conductance and current------------------------------!
		j0 = ((pw-1)*ne_pw)+1
		jf = pw*ne_pw
		cond_e(pw) = cond_e(pw)*pr(35) + SUM(spkr(j0:jf)*msynw(j0:jf))
		curr_e(pw) = cond_e(pw)*x(1)
	!------------------------------------------------------------------------------------------!
	!--------------------inhibitory conductance and current for pop 1--------------------------!
		j0 = ((pw-1)*ni_pw1)+ne_input+1
		jf = pw*ni_pw1+ne_input
		cond_i1(pw) = cond_i1(pw)*pr(36) + SUM(spkr(j0:jf)*msynw(j0:jf))
		curr_i1(pw) = - cond_i1(pw)*(pr(32)-x(1))
	!------------------------------------------------------------------------------------------!
	!--------------------inhibitory conductance and current for pop 2--------------------------!
		j0 = ((pw-1)*ni_pw2)+ne_input+ni_input1+1
		jf = pw*ni_pw2+ne_input+ni_input1
		cond_i2(pw) = cond_i2(pw)*pr(36) + SUM(spkr(j0:jf)*msynw(j0:jf))
		curr_i2(pw) = - cond_i2(pw)*(pr(32)-x(1))
	!------------------------------------------------------------------------------------------!
	END DO
!==========================================================================================!
!-----------------------------------leak currents------------------------------------------!
	curr_leak = x(1) - pr(2)
!------------------------------------------------------------------------------------------!
!============================== WRITING TO FILES ==========================================!
!---------------------------membrane potential---------------------------------------------!
	IF(spk_post) WRITE(1,*)tr,-25.0d0		!spike
	WRITE(1,*)tr,x(1)				!subthreshold
!------------------------------------------------------------------------------------------!
!--------------------------------input activity--------------------------------------------!
	WRITE(2,"(17E20.5)")tr,activity/200.0d0
!------------------------------------------------------------------------------------------!
!--------------------------------OU variable-----------------------------------------------!
	WRITE(3,"(17E20.5)")tr,patt_time
!------------------------------------------------------------------------------------------!
!--------------------------------currents--------------------------------------------------!
	WRITE(4,"(5E20.5)")tr,SUM(curr_e),SUM(curr_i1),SUM(curr_i2),curr_leak
!------------------------------------------------------------------------------------------!
!==========================================================================================!
	END SUBROUTINE
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
